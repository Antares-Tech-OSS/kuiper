##
# KUIPER Nginx Template
##

#
# HTTP redirect to HTTPS
#
server {
	listen 80 default_server;
	listen [::]:80 default_server;
	server_name _;
	return 301 https://$host$request_uri;
}

# Rate limiting: each IP address can make upto <rate> requests per second
limit_req_zone $binary_remote_addr zone=limit_50ps:4m rate=50r/s;


#
# HTTPS Termination of all services
#
server {

	listen 443;
	server_name @host;

	ssl_certificate           /etc/nginx/ssl/dev-cert.crt;
	ssl_certificate_key       /etc/nginx/ssl/dev-key.key;

	ssl on;
	ssl_session_cache         builtin:1000  shared:SSL:10m;
	ssl_protocols             TLSv1 TLSv1.1 TLSv1.2;
	ssl_ciphers               HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4;
	ssl_prefer_server_ciphers on;
	access_log                /var/log/nginx/@host;
	root                      /home/@user/webrtc/apps/landing;
	#client_max_body_size   50M;

	# compression settings
	gzip on;
	gzip_types application/octet-stream text/plain text/css application/json application/x-javascript application/javascript text/xml application/xml application/rss+xml text/javascript image/svg+xml application/vnd.ms-fontobject application/x-font-ttf;
	gzip_min_length 1024;


	location  ~ ^/(auth) {

		proxy_set_header        Host $host;
		proxy_set_header        X-Real-IP $remote_addr;
		proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header        X-Forwarded-Proto $scheme;
		rewrite                 ^/auth/(.*)$ /$1 break;

		proxy_pass             http://localhost:3002;
		proxy_read_timeout     90;
		client_max_body_size   50M;
	}

}
